<div class="match-card" [class.expanded]="isExpanded" (click)="toggleAnalysis()">
  <div class="card-header">
    <span class="date">{{ match.date | date:'MMM d, y, h:mm a' }}</span>
    <div class="actions">
      <a [href]="'https://www.flashscore.com/match/' + match.matchId + '/#/match-summary'" target="_blank"
        rel="noopener noreferrer" (click)="$event.stopPropagation()" class="fs-link">
        Flashscore ↗
      </a>
      <span class="status" *ngIf="match.isParsed">Parsed</span>
    </div>
  </div>

  <div class="teams-container">
    <div class="team home">
      <div class="name">{{ match.homeTeam }}</div>
    </div>

    <div class="score-board">
      <div class="score" *ngIf="match.score; else pending">
        {{ match.score }}
      </div>
      <ng-template #pending>
        <div class="vs">VS</div>
      </ng-template>
      <div class="goals-info" *ngIf="match.goalsCount !== undefined">
        <span class="pill" title="Total Goals">Total: {{ match.goalsCount }}</span>
        <span class="pill" title="1st Half Goals">1st Half: {{ match.firstHalfGoals ?? 0 }}</span>
        <span class="pill" title="2nd Half Goals">2nd Half: {{ match.goalsCount - (match.firstHalfGoals ?? 0) }}</span>
      </div>
    </div>

    <div class="team away">
      <div class="name">{{ match.awayTeam }}</div>
    </div>
  </div>

  <!-- Analysis Section -->
  <div class="analysis-section" *ngIf="isExpanded" (click)="$event.stopPropagation()">
    <div class="loading-state" *ngIf="isLoadingAnalysis">
      Loading stats...
    </div>

    <div class="stats-content" *ngIf="analysis">
      <div class="stats-table-wrapper">
        <table class="stats-table">
          <thead>
            <tr>
              <th>Year</th>
              <th>Team</th>
              <th>G</th>
              <th>>0.5</th>
              <th>>1.5</th>
              <th>>2.5</th>
              <th>FH >0.5</th>
              <th>FH >1.5</th>
              <th>FH >2.5</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of analysis.stats" [class.highlight]="row.year === 2025 || row.year === 2026">
              <td>{{ row.year }}</td>
              <td>{{ row.team }}</td>
              <td>{{ row.totalGames }}</td>
              <td [class.high-prob]="(row.over05 / row.totalGames) * 100 >= thresholds.over05">{{ row.over05 }}</td>
              <td [class.high-prob]="(row.over15 / row.totalGames) * 100 >= thresholds.over15">{{ row.over15 }}</td>
              <td [class.high-prob]="(row.over25 / row.totalGames) * 100 >= thresholds.over25">{{ row.over25 }}</td>
              <td [class.high-prob]="(row.overFH05 / row.totalGames) * 100 >= thresholds.overFH05">{{ row.overFH05 }}
              </td>
              <td [class.high-prob]="(row.overFH15 / row.totalGames) * 100 >= thresholds.overFH15">{{ row.overFH15 }}
              </td>
              <td [class.high-prob]="(row.overFH25 / row.totalGames) * 100 >= thresholds.overFH25">{{ row.overFH25 }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="predictions-grid">
        <div class="pred-box">
          <div class="label">Full Time</div>
          <div class="value">{{ analysis.predictions.fullTime }}</div>
        </div>
        <div class="pred-box">
          <div class="label">1st Half</div>
          <div class="value">{{ analysis.predictions.firstHalf }}</div>
        </div>
        <div class="pred-box">
          <div class="label">2nd Half</div>
          <div class="value">{{ analysis.predictions.secondHalf }}</div>
        </div>
      </div>

      <!-- Recent Form (Last 5) -->
      <div class="predictions-grid" style="margin-top: 15px;" *ngIf="analysis.homeForm && analysis.awayForm">
        <div class="pred-box">
          <div class="label">Home Form (Last 5)</div>
          <div class="value">
            <div style="font-size: 0.9em;">Goals: {{ analysis.homeForm.last5Goals?.join(', ') }}</div>
            <div style="font-size: 0.8em; color: #888;">Avg: {{ analysis.homeForm.avgGoals }}</div>
          </div>
        </div>
        <div class="pred-box">
          <div class="label">Away Form (Last 5)</div>
          <div class="value">
            <div style="font-size: 0.9em;">Goals: {{ analysis.awayForm.last5Goals?.join(', ') }}</div>
            <div style="font-size: 0.8em; color: #888;">Avg: {{ analysis.awayForm.avgGoals }}</div>
          </div>
        </div>
      </div>

      <div class="legend">
        <span class="indicator"></span> Green numbers indicate high probability (≥{{thresholds.over05}}% for 0.5,
        ≥{{thresholds.over15}}% for 1.5, ≥{{thresholds.over25}}% for 2.5).
      </div>
    </div>
  </div>
</div>